name: ğŸš€ SEVER AI STV PREMIUM (TURBO MODE)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 345 # TÄƒng nháº¹ Ä‘á»ƒ trÃ¡nh timeout phÃºt cuá»‘i
    
    steps:
      # 1. KHá»I Äá»˜NG & Tá»I Æ¯U WINDOWS (BÆ°á»›c quan trá»ng nháº¥t Ä‘á»ƒ giáº£m lag)
      - name: ğŸš€ Tá»I Æ¯U HÃ“A Há»† THá»NG (ANTI-LAG)
        run: |
          Write-Host "ğŸ”¥ ÄANG KÃCH HOáº T CHáº¾ Äá»˜ HIá»†U SUáº¤T CAO..." -ForegroundColor Yellow

          # 1. Táº¯t Windows Defender Real-time (TÄƒng tá»‘c cá»±c máº¡nh cho Github Runner)
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          
          # 2. Tá»‘i Æ°u Registry cho RDP (Giáº£m Ä‘á»™ trá»…, táº¯t hÃ¬nh ná»n, táº¯t hiá»‡u á»©ng)
          $tweaks = @(
              # Táº¯t hÃ¬nh ná»n (MÃ n hÃ¬nh Ä‘en = load nhanh)
              @{Path="HKCU:\Control Panel\Desktop"; Name="Wallpaper"; Value=""},
              @{Path="HKCU:\Control Panel\Desktop"; Name="WallpaperStyle"; Value="0"},
              # Táº¯t Font Smoothing (Giáº£m má»)
              @{Path="HKCU:\Control Panel\Desktop"; Name="FontSmoothing"; Value="0"},
              # Táº¯t Show window contents while dragging
              @{Path="HKCU:\Control Panel\Desktop"; Name="DragFullWindows"; Value="0"},
              # Táº¯t Menu Animation
              @{Path="HKCU:\Control Panel\Desktop"; Name="UserPreferencesMask"; Value=[byte[]](0x90,0x12,0x03,0x80)},
              # Tá»‘i Æ°u TCP cho RDP
              @{Path="HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters"; Name="TcpWindowSize"; Value=64240},
              @{Path="HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters"; Name="GlobalMaxTcpWindowSize"; Value=64240}
          )

          foreach ($t in $tweaks) {
              New-Item -Path $t.Path -Force -ErrorAction SilentlyContinue | Out-Null
              Set-ItemProperty -Path $t.Path -Name $t.Name -Value $t.Value -Force -ErrorAction SilentlyContinue
          }

          # 3. Táº¯t cÃ¡c Services gÃ¢y náº·ng mÃ¡y vÃ  tá»‘n bÄƒng thÃ´ng
          $servicesToStop = @("Audiosrv", "AudioEndpointBuilder", "Themes", "WerSvc", "WSearch", "SysMain")
          foreach ($svc in $servicesToStop) {
              Stop-Service -Name $svc -Force -ErrorAction SilentlyContinue
              Set-Service -Name $svc -StartupType Disabled -ErrorAction SilentlyContinue
              Write-Host "â”‚ ğŸš« ÄÃ£ táº¯t service: $svc" -ForegroundColor Gray
          }

          # 4. Cáº¥u hÃ¬nh Performance Options
          # Chá»‰nh VisualFXSetting vá» 2 (Adjust for best performance)
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2 -Force -ErrorAction SilentlyContinue

          Write-Host "âœ… ÄÃ£ tá»‘i Æ°u hÃ³a há»‡ thá»‘ng Ä‘á»ƒ Ä‘áº¡t tá»‘c Ä‘á»™ tá»‘i Ä‘a!" -ForegroundColor Green

      # 2. Cáº¤U HÃŒNH RDP NÃ‚NG CAO
      - name: ğŸ”§ Cáº¤U HÃŒNH RDP (NO NLA)
        run: |
          Write-Host "ğŸ› ï¸  ÄANG Cáº¤U HÃŒNH RDP..." -ForegroundColor Yellow
          
          # Má»Ÿ port vÃ  táº¯t NLA (Network Level Authentication) Ä‘á»ƒ dá»… káº¿t ná»‘i
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1 -Force # 1 = Low secure but fast
          
          # Firewall rules
          netsh advfirewall firewall add rule name="Allow RDP" dir=in action=allow protocol=TCP localport=3389 profile=any | Out-Null
          
          Write-Host "âœ… Cáº¥u hÃ¬nh RDP hoÃ n táº¥t!" -ForegroundColor Green

      # 3. Táº O USER PREMIUM
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N
        run: |
          # Logic táº¡o máº­t kháº©u
          function New-PremiumPassword {
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'; $lower = 'abcdefghijkmnpqrstuvwxyz'; $numbers = '23456789'
              $pw = $upper[(Get-Random $upper.Length)] + $lower[(Get-Random $lower.Length)] + $numbers[(Get-Random $numbers.Length)]
              1..5 | ForEach-Object { $pw += ($upper+$lower+$numbers)[(Get-Random ($upper+$lower+$numbers).Length)] }
              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }

          $matKhau = if ($env:CUSTOM_RDP_PASS) { $env:CUSTOM_RDP_PASS } else { New-PremiumPassword }
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          
          # XÃ³a vÃ  táº¡o má»›i User
          Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "Optimized RDP User"
          
          # Cáº¥p quyá»n Admin & RDP
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM"
          
          # LÆ°u máº­t kháº©u
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          $matKhau | Out-File "$env:TEMP\rdp_password.txt" -Encoding ascii
          
          Write-Host "âœ… ÄÃ£ táº¡o User: AISTV-PREMIUM" -ForegroundColor Green

      # 4. TAILSCALE (Máº NG)
      - name: ğŸŒ Káº¾T Ná»I TAILSCALE
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "ğŸŒ KHá»I Äá»˜NG TAILSCALE..." -ForegroundColor Yellow
          
          # Download & Install nhanh gá»n
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "$(Invoke-WebRequest $url -OutFile 'ts.msi' -PassThru).FullName", "/quiet", "/norestart" -Wait
          
          # Up Tailscale (ThÃªm --accept-dns=false Ä‘á»ƒ trÃ¡nh lá»—i máº¡ng cá»¥c bá»™ Github)
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname="aistv-turbo-$env:GITHUB_RUN_ID" --accept-routes --accept-dns=false
          
          # Láº¥y IP
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "âœ… IP: $ip" -ForegroundColor Green

      # 5. HIá»‚N THá»Š THÃ”NG TIN (Gá»n gÃ ng)
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          $pass = Get-Content "$env:TEMP\rdp_password.txt"
          
          # Chuyá»ƒn Ä‘á»•i duration
          $min = switch ("${{ github.event.inputs.duration }}") { '1h' {60} '3h' {180} '5h40m' {340} default {340} }
          echo "TOTAL_MINUTES=$min" >> $env:GITHUB_ENV
          
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘        ğŸš€ SEVER AI STV TURBO READY         â•‘" -ForegroundColor Cyan
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
          Write-Host "â•‘ ğŸ“¡ IP:       $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â•‘ ğŸ‘¤ User:     AISTV-PREMIUM" -ForegroundColor White
          Write-Host "â•‘ ğŸ”‘ Pass:     $pass" -ForegroundColor White
          Write-Host "â•‘ âš¡ Mode:     Performance (No Lag)" -ForegroundColor Yellow
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan

      # 6. LOOP GIá»® Káº¾T Ná»I (Tá»‘i Æ°u CPU tháº¥p nháº¥t)
      - name: â³ SERVER RUNNING...
        run: |
          $totalMinutes = [int]$env:TOTAL_MINUTES
          $endTime = (Get-Date).AddMinutes($totalMinutes)
          
          Write-Host "â³ Server Ä‘ang cháº¡y. Vui lÃ²ng khÃ´ng Ä‘Ã³ng tab nÃ y..." -ForegroundColor Magenta
          
          # VÃ²ng láº·p tá»‘i Æ°u: Ngá»§ 10s má»›i in log 1 láº§n Ä‘á»ƒ tiáº¿t kiá»‡m tÃ i nguyÃªn Runner
          while ((Get-Date) -lt $endTime) {
              $tl = $endTime - (Get-Date)
              $str = "{0:D2}:{1:D2}:{2:D2}" -f $tl.Hours, $tl.Minutes, $tl.Seconds
              Write-Host "`rğŸ”´ LIVE | Thá»i gian cÃ²n láº¡i: $str | Status: Healthy " -NoNewline -ForegroundColor Green
              
              # Anti-Idle trick nháº¹
              [void][System.Reflection.Assembly]::LoadWithPartialName('System.Windows.Forms')
              [System.Windows.Forms.SendKeys]::SendWait(".") | Out-Null
              
              Start-Sleep -Seconds 10
          }

